<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>

    <!-- Things to Finish
        - Get API to work
            - Display weather for each coming day and the current weather with more details at the top
        - Local Storage
            - Save info
            - Warn when not saved
            - Clear local storage
            - Repopulate everything - see if there's any easy way to do this
        - Decorate the page more cleanly
            - Look into google style sheets
            - Other CSS
        - Add a delete button
            - For each item
            - For the whole day
            - For all days
            - Add a reset button 
        - Separate into index html file
        - Add to github
            - Make the website show up when you click on it

    -->

    <!-- GetjQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <style>
        body {
            background-color: rgb(241, 206, 231);
        }

        .container{
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .dayContainer{   /* puts border around all div elements in the container*/
            border: 3px rgb(18, 50, 230) solid;
            padding: 5px;
            max-width: 300px
        }

        .weather-container {
            display: flex;
            justify-content: center;
            align-items: stretch;
            flex-wrap: wrap;
            padding-right: 0px;
            gap: 10px;
            padding-top: 0px;
        }

        .day-container-header {
            display: flex;
            justify-content: space-between;
        }

        .day-title {
            color: blue;
            line-height: 0px;
            margin-bottom: 0px;
            justify-content: left;
        }

        #page-title {
            color:blue;
            gap: 10px;
        }
        
        ul {
            word-wrap: break-word;
            flex-wrap: nowrap;
        }

        .day-subtitle {
            color: blue;
            font-style: italic;
            padding-bottom: 0px;
        }

        #add-new{
            color: rgb(165, 161, 161);
            
        }

        #add-new-header {
            margin-bottom: 0px;
        }

        #add-new-button {
            text-align: center;
            font-size: 40px;
        }

        .remove-button {
            color: red;
            float: right;
        }

        #save-button {
            align-items: right;
            /* background-color:rgb(255, 0, 0); */
            /* color: rgb(255, 255, 255); */
            size: 100px;
        }
    </style>
    
    <h1 id='page-title'>To-do's for the week</h1>

    <form>
        <h4>Enter your zip to see the local weather forecast</h3>
        <input id="weather-input">
        <input id="add-zip" type="button" value="Get weather">
    </form>
    <br>
    <form id='save-button-form'>
        <input id="save-button" disabled type="button" value="Save List" title="Allows you to navigate away from the page and see your list when you return">
    </form>
    <br>

    <div class="container">

        <div class='dayContainer' id='day0'>
            <h1 class='day-container-header'>
                <span class = 'day-title' id='title0'>
            </h1>
            <p class = 'day-subtitle' id='subtitle0'><p>
            <div class="weather-container">
                <img class="icon">
                <p class="weather"></p>
                <p class="temp"></p>
            </div>
            <div class="add-button-container">
                <input class = 'input' id="input0">
                <input id="add0" type="button" value="Add">
                <ul class='list' id="list0"></ul>
            </div>
        </div>

        <div class='dayContainer' id='day1'>
            <h1 class='day-container-header'>
                <span class = 'day-title' id='title1'>
            </h1>
            <p class = 'day-subtitle' id='subtitle1'><p>
            <div class="weather-container">
                <img class="icon">
                <p class="weather"></p>
                <p class="temp"></p>
            </div>
            <input id="input1">
            <input id="add1" type="button" value="Add">
            <ul id="list1"></ul>
        </div>

        <div class='dayContainer'>
            <h1 class = 'day-title'></h1>
            <p class = 'day-subtitle'><p>
            <div class="weather-container">
                <img class="icon">
                <p class="time"></p>
                <p class="weather"></p>
                <p class="temp"></p>
            </div>
            <input>
            <input type="button" value="Add">
            <ul></ul>
        </div>

        <div id='add-new'>
            <h1 id='add-new-header'>Add another day <span id =add-new-button>+</span></h1>
                </div>
              </div>
            </h1>
        </div>
    </div>

    <script>

        //comment out later
        window.localStorage.clear();
        let zip = 94939;
        getWeather();
        let dayNumber = 0;

        let today = new Date();
        let daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        let monthsOfYear = ['January','February','March','April','May','June','July','August','September','October','Novemeber','December'];

        for (let dayOnCalendar = 0; dayOnCalendar < 3/*Needs to be dynamic*/; dayOnCalendar++) {
            populateDates(dayOnCalendar);
        }
        
        function populateDates(dayOnCalendar) {
            let container = document.getElementsByClassName('container')[0];

            // find the last day so we can add after it - would have been easier to go from the end of the container
            let dayContainers = container.getElementsByClassName('dayContainer');
            let numberDays = dayContainers.length;
            let currentDay = dayContainers[dayOnCalendar];
            console.log('*****')
            console.log(currentDay)

            let title = currentDay.getElementsByClassName('day-title')[0];
            let subtitle = currentDay.getElementsByClassName('day-subtitle')[0];

            today.setDate(today.getDate() + dayOnCalendar)
            title.innerHTML = `${daysOfWeek[today.getDay()]}`;
            subtitle.innerHTML = `${monthsOfYear[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
            return;
        }

        let add1 = document.getElementById('add0');
        add1.addEventListener('click', function() {
            addNewItem(this);
        });

        let counter = localStorage.length;

        function addNewItem(element) {

            let input = element.parentNode.getElementsByTagName('input')[0];
            let inputText = input.value; 
            if (inputText) {
                let list = element.parentNode.getElementsByTagName('ul')[0];

                if (list.getElementsByTagName('li').length == 0) {
                    addClearButton();
                }

                // add new item
                let newItem = document.createElement('li');
                newItem.className = 'item';
                newItem.innerHTML = inputText + '<strong class="remove-button" onclick="removeItem(event)">[x]</strong>';;
                list.append(newItem)



                localStorage.setItem(counter, inputText);
                console.log(`Added "${inputText}" to local storage`);
                counter++;

                input.value = '';

                activateSaveButton();

            } else {
            window.alert('Please enter a to-do item in order to add it to your list');
        }
        }

        // remove individual item in list
        function removeItem(event) {
            event.currentTarget.closest('li').remove();
        }

        function addClearButton() {
            let list0 = document.getElementById('list0');
            let clearButton = document.createElement('input');
            clearButton.id = 'clear';
            clearButton.type = 'button';
            clearButton.value = 'Clear All';
            clearButton.addEventListener('click', clearList);
            
            let br = document.createElement('br');

            list0.before(br);
            list0.before(clearButton);

            console.log('Adding clear button');
        }

        // clears entire list
        function clearList() {
            // clear list
            let list = document.getElementById('list0');

            while (list.firstChild) {
                list.removeChild(list.firstChild);
            }

            // remove clear button
            let clearButton = document.getElementById('clear');
            clearButton.remove();
        }

        function addNewItemFromLocalStorage(itemFromLocal) {

            let list = document.getElementById('list0');
            let newItem = document.createElement('li');

            newItem.className = 'item';
            newItem.innerHTML = itemFromLocal;
            list1.append(newItem);

        }

        function addListFromLocalStorage() {
            console.log(localStorage.length);
            for (let i = 0; i < localStorage.length; i++){
                let localItem = localStorage.getItem(localStorage.key(i));
                addNewItemFromLocalStorage(localItem);

                console.log(`Added "${i}: ${localItem}" from local storage`);
            }
        }

        addListFromLocalStorage();

        
        function addNewDay() {

            //***Fill in code from practice here**
            return;
        }

        // let stop = 0;
        // for([key,value] in window.localStorage) {
        //     console.log(`${key}: ${window.localStorage.getItem(key)} aka ${value}`);

        //     stop++;
        //     if (stop > 10) {
        //         break;
        //     }
        // }
        
        
        // also session storage to store your session
        // info stored in chrome dev tools under application
        
        //set item in local storage
        // localStorage.setItem('name', 'John');

        // get item in local storage

        // let myName = localStorage.getItem('name');
        // console.log(myName);


        // **** Need to get this to work later ***

        let zipInput = document.getElementById('add-zip');            
        zipInput.addEventListener('click', getWeather);

        // async function getUsers(url) {
        //     let response = await fetch(url);
        //     let data = await response.json()
        //     return data;
        //     }  

        function getWeather() {

            try {

                // Get coordinates from this API
                let url = `http://api.openweathermap.org/data/2.5/weather?zip=${zip}&units=imperial&appid=c2541fa183a6d1bc7a654334c0eadb43`;

                let lat;
                let lon;

                $.getJSON(url, function(data) {

                    lat = data.coord.lat;
                    lon = data.coord.lon;
                    console.log(` Latitude ${lat}`);
                    console.log(` Longitude ${lon}`);

                })

                // Update to async/await later
                setTimeout( function() {  
                    // Use those  coordinates to get the forecast. Forecast API only accepts coordinates
                        // documentation: https://openweathermap.org/api/one-call-api
                    let urlForecast = `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${lon}&exclude=current,minute,hourly,alerts&units=imperial&appid=c2541fa183a6d1bc7a654334c0eadb43`;
                    console.log(`URL: ${urlForecast}`);


                    $.getJSON(urlForecast, function(data) {

                        let minTemp = data.daily[dayNumber].temp.min;
                        let maxTemp = data.daily[dayNumber].temp.max;
                        console.log(`${minTemp}F - ${maxTemp}F`);

                        // they provide a url for the icons, but icon id is in the data
                        let icon = `http://openweathermap.org/img/w/${data.daily[dayNumber].weather[0].icon}.png`;
                        let weatherDescription = data.daily[dayNumber].weather[0].main;

                        // needs to get called when you create
                        let day0 = document.getElementById('day0');
                        day0.getElementsByClassName('icon')[0].src = icon;
                        day0.getElementsByClassName('temp')[0].innerHTML = `${minTemp} - ${maxTemp}F&#176;`;
                        day0.getElementsByClassName('weather')[0].innerHTML = weatherDescription;
                    })}
                , 600);
                // Use those coordinates to get a forecast
            } catch(error) {
                    console.log('Did not work');
                }


        }           
        
        // add new day
        let addNewButton = document.getElementById('add-new');
        addNewButton.onclick = addNewDay;
        
        function addNewDay() {
            let container = document.getElementsByClassName('container')[0];
            console.log(container);

            // find the last day so we can add after it - would have been easier to go from the end of the container
            let dayContainers = container.getElementsByClassName('dayContainer');
            let numberDays = dayContainers.length;
            let lastDay = dayContainers[numberDays-1];
            console.log(lastDay)

            // add new dayContainer
            let newDayContainer = document.createElement('div');
            newDayContainer.className = 'dayContainer';
            
            newDayContainer.innerHTML = `
                <h1 class='day-container-header'>
                    <span class = 'day-title'>
                </h1>
                <p class = 'day-subtitle'><p>
                <div class="weather-container">
                    <img class="icon">
                    <p class="weather"></p>
                    <p class="temp"></p>
                </div>
                <div class="add-button-container">
                    <input class = 'input'>
                    <input type="button" value="Add">
                    <ul class='list'></ul>
                    
                </div>`;

            lastDay.parentNode.insertBefore(newDayContainer, lastDay.nextSibling);

            // populateDates(lastDay + 1);

            let dayOnCalendar = 3;
            let container1 = document.getElementsByClassName('container')[0];
            // find the last day so we can add after it - would have been easier to go from the end of the container
            let dayContainers1 = container1.getElementsByClassName('dayContainer');
            let numberDays1 = dayContainers1.length;
            let currentDay1 = dayContainers1[dayOnCalendar];

            let title = currentDay1.getElementsByClassName('day-title')[0];
            let subtitle = currentDay1.getElementsByClassName('day-subtitle')[0];

            today.setDate(today.getDate() + dayOnCalendar)
            title.innerHTML = `${daysOfWeek[today.getDay()]}`;
            subtitle.innerHTML = `${monthsOfYear[today.getMonth()]} ${today.getDate()}, ${today.getFullYear()}`;
            console.log('title style' + title.style);
            return;

        }
    
        function saveItems() {
            window.localStorage.clear();

            // add zip to local storage
            localStorage.setItem('zip', zip);

            // add items
            let itemsInLists = {};
            let days = document.getElementsByClassName('dayContainer');
            console.log(days);
            for (day of days) {
                // store the day
                console.log(day);
                let date = day.getElementsByClassName('day-subtitle')[0].innerHTML;
                itemsInLists[date] = [];

                // get each individual item
                let items = day.getElementsByClassName('item');
                for (item of items) {
                    itemsInLists[date].push(item);
                }
            }
            console.log(itemsInLists);
            localStorage.setItem('items', itemsInLists);

            // reset save button by clearing and creating a new one
            document.getElementById('save-button').remove();
            let saveButtonForm = document.getElementById('save-button-form');
            let newSaveButton = document.createElement('input');
            newSaveButton.id = 'save-button';
            newSaveButton.disabled = true;
            newSaveButton.type = 'button'
            newSaveButton.value = 'Save List';
            newSaveButton.title = 'Allows you to navigate away from the page and see your list when you return';
            newSaveButton.onclick = 'saveItems';
            saveButtonForm.append(newSaveButton);
        }

        function activateSaveButton() {
            let saveButton = document.getElementById('save-button');
            saveButton.onclick = saveItems;
            saveButton.disabled = false;
            saveButton.style.backgroundColor = 'rgb(255, 0, 0)';
            saveButton.style.color = 'rgb(255, 255, 255)';
        }

        // Notify if not saved
        // let saveListButton = document.getElementById('save-button');
        // console.log(saveListButton.disabled)
        // window.addEventListener('beforeunload', function (e) {
        //     if (!saveListButton.disabled) {
        //         e.preventDefault();
        //         e.returnValue = '';
        //     }
        // });

    </script>
</body>
</html>
